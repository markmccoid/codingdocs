# Firebase

[Firebase Web Starting Docs](https://firebase.google.com/docs/database/web/start)

[Firebase Database Ref Docs](https://firebase.google.com/docs/reference/js/firebase.database.Reference "Firebase Docs")

## Basics

To set up firebase in an application, you will first need to grab the configuration script from the firebase site. Note, this will be different for each Database you use.

When you are in your new database application area, click on the **Overview** menu option on the left and choose to get the configuration for the web.

```javascript
var config = {
  apiKey: "AIzaSyBs7pnXGSlMYtin7tEtTijRYR_iBLRmz-A",
  authDomain: "expensify-e6b86.firebaseapp.com",
  databaseURL: "https://expensify-e6b86.firebaseio.com",
  projectId: "expensify-e6b86",
  storageBucket: "expensify-e6b86.appspot.com",
  messagingSenderId: "730922088689"
};
firebase.initializeApp(config);
```

## .database() Functions

Once you have run the *initializeApp* function, passing it your "config" object, you will then have access to all of Firebase's capabilities.

One of the main capabilities that you will be using is the database functions.  To access these database functions you will use:

```javascript
var firebaseDB = firebase.database()
```

[database() docs](https://firebase.google.com/docs/reference/js/firebase.database.Database)

But most often you will want to get to the database reference.  Do this as follows:

```javascript
var firebaseRef = firebase.database().ref();
```

The above assumes you have imported firebase into your application and called it "firebase".

Note that the above "ref" is giving you access to your DB root.  You can think of a ref() as a reference to a location in your database.  It could be a table or a row.  

You can now use firebaseRef to manipulate your database. 

Your database is made up of nodes and to move around these nodes, you can use the .child() function. Here is a simple DB:

![](./images/DraggedImage.png)

If I wanted to get a reference to the 0 entry above, I would do the following:

```javascript
var fbRef = firebaseRef.child('users/0');   
```

I can now run any command on the fbRef entry (set(), update(), remove(), etc.). I can also get the "key" for that array entry by:

```javascript
consolelog(fbRef.key);
```

Note, that if you create an array by passing an array object, you will get the standard type index (0,1,2,...), if you use the push() command, you will get a firebase style key.

Last thing to remember is that you just about everything you do return a **promise:** 

[Keeping our Promises (and Callbacks)](https://firebase.googleblog.com/2016/01/keeping-our-promises-and-callbacks_76.html)


## Arrays in Firebase

Arrays in firebase are handled by creating unique keys for each item in an array. Each item being an object, i.e. you can have more than one item in this array object.

![](./images/DraggedImage-1.png)

The **push()** firebase function adds one of these unique keyed objects to the node that you have a reference to. In the code below, we first push on item into the 'notes' node. Note we are saving a reference to this new node and in the next link use the set() function to add data to the new item.

In the next example, I am showing that you can chain the set to the push, however, you will not get a reference back to the new item.

```javascript
var notesRef = firebaseRef.child('notes');

var newNoteRef = notesRef.push();
newNoteRef.set({
		noteText: 'Example Text 1'
});

notesRef.push().set({
		noteText: 'Example Text 2'
});
```

Since push is used so much, you can simplify this by sending the items value as an object passed to push.

```javascript
var newNoteRef = notesRef.push({
		noteText: 'Example Text 1'
});

console.log(newNoteRef.key);
```

Here the newNoteRef is a reference to this new item and one of the properties of this class is the key of the new item. Note that the key is generated by firebase.

# Adding/Updating Data/Deleting

[FirebaseDocs](https://firebase.google.com/docs/reference/js/firebase.database.Reference "Firebase Docs")

First thing to understand when using the following firebase functions is that they are all asynchronous and return promises.

## [Set](https://firebase.google.com/docs/reference/js/firebase.database.Reference#set)

Set will destroy and create. Meaning, if something exists at the node you are setting, it will be removed and then whatever set is creating will be created.

So, you can pass in anything you want, even a structure that is different.  Just know that set is going to removed what was at the ref and replace it with the object you are sending in.

Set's promise does not return a value when it completes.

## [Update](https://firebase.google.com/docs/reference/js/firebase.database.Reference#update)

Update will do exactly what it says, it will update whatever node you have a reference to. You do not have to pass all of the items in the node, just the ones that you want to update.

![](./images/DraggedImage-2.png)

If I want to update the age of the above entry, there are a couple of ways:

```javascript
//update all in one go:
firebaseRef.child('users/0').update({age: 46});

//this way will get reference first:
var updRef = firebaseRef.child('users/0');
updRef.update({age: 46});
```

If you run an update and no item exists to update, it will be created.

If you want to remove a piece of data with an update, pass **null** as the updated value.  Want to add data that doesn't exist in ref, just include it in object.  Want to update an existing piece of data, just include it.

```javascript
//A call to update, can Update, Remove (by passing null) and Add
firebase.database().ref('attributes')
  .update({
    height: 70,
    IQ: 143,
    weight: null
  });
```

Below are the before and after snapshots of the database after the above update.

![firebase-01](C:\Users\mark.mccoid\Dropbox\md-images\jsdocs\firebase-01.png)

What if I wanted to perform the same updates as above, but also change the **age** property using only one update.

This can be done, but you first must understand that you cannot directory update nested objects.

```javascript
firebase.database().ref().update({
    age: 35,
  	attributes: {
        IQ:143
    }
})
```

The above would make the attributes property equal to only the IQ property.  To do this, you need to use a bit of odd syntax:

```javascript
firebase.database().ref().update({
  age: 35,
  'attributes/IQ': 143,
  'attributes/height': 70,
  'attributes/weight': null,
});
```



## Delete data (Remove)

**remove(onComplete)** returns firebase.Promise containing void

Removes the data at this Database location.

Any data at child locations will also be deleted.

The effect of the remove will be visible immediately and the corresponding event 'value' will be triggered. Synchronization of the remove to the Firebase servers will also be started, and the returned Promise will resolve when complete. If provided, the onComplete callback will be called asynchronously after synchronization has finished.

```javascript
var fbRef = firebase.database().ref('users/ada');
fbRef.remove()
	.then(function() {
		console.log("Remove succeeded.")
	})
	.catch(function(error) {
		console.log("Remove failed: " + error.message)
	});
```

# Retrieving Data

## .once() call

You can get data from a reference one time using the once function:

```javascript
const database = firebase.database();
database.ref().once('value')
	.then((snapshot) => {
    	//Get the data from the snapshot
  		const data = snapshot.val();
	})
	.catch((e) => {
    	//Error Code
	})
```

Get more information on the snapshot parameter: [Snapshot Documentation](https://firebase.google.com/docs/reference/js/firebase.database.DataSnapshot)

You can use the **forEach** firebase snapshot method to take firebase's object like representation of data and transform to an array when reading it in:

```javascript
const database = firebase.database();

database.ref('expenses').once('value')
  .then((snapshot) => {
    console.log(snapshot.val());
    // Create Array to hold return from  DB
    const expenses = [];
    // Use the firebase forEach method to push the children into our array
    snapshot.forEach((childSnapshot) => {
      expenses.push({
        id: childSnapshot.key, // .key will be the key for child
        ...childSnapshot.val()
      });
    });
  });
```

![firebase-snapshot02](C:\Users\mark.mccoid\Dropbox\md-images\jsdocs\firebase-snapshot02.png)

##  Listening for Changes - on

You can subscribe to changes in the database by using the on function as follows:

```javascript
firebase.initializeApp(config);
const database = firebase.database();
//When subscribing to changes, you will get the callback function returned.
//Store this in a variable and you will be able to use it to turn off just 
//that single subscription.
const onValueChange = database.ref()
  .on('value', (snapshot) => {
    const val = snapshot.val();
    //-- Do something with data
  }, (e) => {
      console.log('this is an error message', e);
  });

//This will turn off listening for all listeners
database.ref().off();

//Turn off a single subscription
database.ref().off(onValueChange);
```

This callback will be executed whenever anything is changed in the database.

You can also listen for changes on specific "nodes"/refs. Like **database.ref('notes').on(...)**

## Other "on" Events 

There are other events that you can listen to with on.  Things like when a child is removed 'child_removed' or when a child is changed 'child_changed' or when a child is added 'child_added'.

You listen for additions to the "array" using the on() function with 'child\_added'

```javascript
var notesRef = firebaseRef.child('notes');

notesRef.on('child_added', (snapshot) => {
	console.log('child added:', snapshot.key, snapshot.val());
});
```

The on() listener can also look for **child\_removed** and **child\_changed** 

## User Management and Authorization

[Manage Users in Firebase | Firebase](https://firebase.google.com/docs/auth/web/manage-users)

## Authentication Rules

These rules define who can see what parts of your data tree.

Here is a basic usage with the assumption that we are authenticating through firebase:

```javascript
{
	"rules": {
		"users": {
			"$uid": {
				".write": "$uid === auth.uid",
				".read": "$uid === auth.uid"
				}
			}  
	}
}
```
To setup your app to use firebase as the authenticator, you will need to first log into your firebase console and go to the DB you are working with, *Authentication* section and then choose your sign in method.

We will review the Google provider here.

To start, simply enable the google provider and click save![firebase-auth01](C:\Users\mark.mccoid\Dropbox\md-images\jsdocs\firebase-auth01.png)

Next, you will need to define your "googleProvider" variable, usually added to your firebase configuration file:

```javascript
//firebase.js
import * as firebase from 'firebase';

const config = {
  ...
}
firebase.initializeApp(config);
const database = firebase.database();
  
//!!Here we are defining our googleProvider
const googleAuthProvider = new firebase.auth.GoogleAuthProvider();

export { firebase, googleAuthProvider, database as default };

```

### Checking State of Login

**i.e. Is the user logged in**

You can use the following snippet to setup a function that will be called whenever the state of the firebase Auth has changed:

```javascript
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    console.log(`logged in as ${user.uid}`);
  } else {
    console.log(`logged out`);
  }
});
```



